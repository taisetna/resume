## AI 기반 멀티뷰 미디어 편집 솔루션 VERTIGO 기능 개선 개발 프로젝트

### 개요

VERTIGO는 세로형 영상. 소위 말하는 세로 직캠 영상 제작에 특화된 AI 기반 멀티뷰 미디어 편집 솔루션이다.

그동안 세로형 영상 제작을 하기 위해서는 본 영상 촬영과 별개로 추가로 인력을 투입하여 찍거나, 프리미어 같은 영상 편집툴을 이용하여 가로형 영상에서 크롭하는 방식을 주로 사용하였다. 

그런데 전자의 경우 인물별 동선에 따라 카메라간 간섭이 발생하다 보니 기대만큼 영상 결과물이 나오지 않을 때가 많았고, 후자의 경우 10명 이상 대규모 인원으로 구성된 아이돌에 대한 세로형 직캠 영상 제작시 인물 수에 비례하여 편집시간이 소요됨은 물론 움직이는 피사체를 편집하는 것도 또한 용이하지 않는 등의 문제가 많았다.

VERTIGO는 보다 효율적이고 퀄리티 높은 세로형 영상 제작이 가능하도록  KBS 기술 연구소에서 개발한 얼굴 인식과 클러스터링 기술이 Face AI 엔진이 탑재된 멀티뷰 미디어 편집 솔루션으로, 현재(21년 3월 1일 기준) 유튜브 KBS Kpop 채널에서 서비스중인 뮤직뱅크 세로 직캠 컨텐츠인 K-FANCAM 제작에 적극 활용중에 있다.

<iframe width="560" height="315" src="https://www.youtube.com/embed/Az6yUzFDz1U" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

본 프로젝트는 KBS 기술 연구소에서 발주한 기능 개선건으로, 기존에 연구소에서 사용중인 2.0 버전에 대한 UI/UX 개선과 함께 고속 렌더링 모듈 연동을 통한 멀티 GPU 환경에서 렌더링 속도 향상, 세로 직캠 영상 렌더링 중 편집 작업 기능과 Face AI 엔진 분석 데이터 처리 속도 향상 등 어플리케이션 성능 향상에 초점을 맞춰 진행되었다.

### 세부내용

* 기간 : 2020.06.08 ~ 2020.12.07
* 개발 언어 : NSIS, C++, C#(Unity)
* 사용 라이브러리 및 에셋
  * AVPro Video(영상 재생 에셋)
  * VLC Unity(영상 재생 에셋)
  * FileBrowserPro(파일 처리 에셋)
  * SoftMaskForUGUI(스크린 마스킹 효과 에셋)
  * MediaInfo(영상 코덱, 해상도 등 영상 정보  확인 라이브러리)
  * Sentinel LDK(Thales社 USB 동글 라이센스 라이브러리)

#### 담당 파트

##### GPU 가속 지원 고속 멀티 렌더링 모듈 연동 컨트롤러 개발

기존 프로그램에서 사용중인 렌더링 모듈은 GPU 가속 렌더링을 지원하지 않아 3분 가량 되는 8K 해상도의 60프레임 영상에서 HD 해상도의 세로 직캠 영상 한편을 만드는데 짧게는 15분에서 길게는 20분 가량 걸리곤 했었다.

그러다 보니 회당 평균 10편 이상 세로 직캠 영상물 만들어야 하는 뮤직뱅크 작업 환경에서 영상 편집을 제외한 영상 렌더링에만 4시간 가까이 소요 되고 있었다.

따라서 본 프로젝트에서는 연구소에서 외주 의뢰를 통해 개발한 GPU 가속이 지원되는 고속 렌더링 라이브러리를 전달 받아 이와 연동하여 동작하는 컨트롤러를 설계, 개발하였다.

해당 모듈에서 Restful API로 연동하는 서버 모드와 C++ DLL 로 동작하는 스탠드 얼론 모드 및 시스템에 탑재된 GPU 디바이스를 선택하여 동작이 가능 했기 때문에 컨트롤러 또한 두 가지 모드를 전부 지원하고, 구동되는 시스템 환경에 설치된 GPU 디바이스 갯수에 따라 병렬 렌더링을 수행할 수 있는 구조로 설계, 개발하였다.

그 결과 동일 영상에 대하여 렌더링시 기존에 비해 작업시간이 절반이상 줄어 들었음은 물론 사용자가 본인이 작업 환경에 맞춰 렌더링 모드를 유연하게 선택하여 사용할 수 있게 되었다. 

또한 컨트롤러에서 제공하는 멀티 렌더링 기능을 통해  작업 시스템의 GPU 구성에 따라 렌더링 작업 시간을 비약적으로 단축 시킬 수 있게 되었다.

**소프트웨어 복사 방지를 위한 라이센스 체크 컨트롤러 개발**

소프트웨어 복사 방지를 위해 프로젝트 초기에는 라이센스 서버에 로그인하여 동작하는 웹인증 방식을 고려했었으나, 작업 영상의 외부 유출 등을 막기 위해 폐쇄망에서 작업하는 경우가 대다수 였기 때문에 PC에 USB 동글키 장착 유무를 확인하는 하드웨어 방식을 선택하였다.

USB 동글 키는 Thales사의 Sentinel 솔루션을 사용하였는데, 이는 이전 회사에서 동일한 목적으로 사용해본 경험이 있었기 때문에 다른 솔루션에 비해 신속하게 개발할 수 있는 장점이 있었기 때문이다. 

##### 키프레임 작업 화면 리뉴얼 및 편집 기능 개선

키프레임 편집은 세로 직캠 제작하는 데 있어 가장 주요한 기능이다 보니 개선에 대한 요구사항이 다른 어떤 부분보다도 많았던 파트였다.

기존 버전에서 키프레임 이동 및 단일 키프레임에 대한 삭제만 지원했었다. 또한 보다 신속한 컨텐츠 제작을 위해 작업 전에 Face AI 엔진을 이용하여 키프레임 데이터를 미리 생성해 놓는 경우가 많았는데, 이 때 엔진에서 유사한 키프레임들은 클러스터라는 단위로 묶어 처리하고 있었다.

그런데 동일한 인물임에도 불구하고 얼굴 각도에 따라 Face AI 엔진에서 다른 사람으로 인식하여 각기 다른 클러스터로 묶은 경우도 있었기 때문에 하나의 클러스터로 합쳐주는 후속 작업이 필요하다. 그런데 기존 버전에서는 화면상에 현재 선택된 클러스터의 키프레임들 외에는 보이지 않았기 때문에 엔진 분석을 통해 생성된 키프레임 데이터들을 한눈에 파악하기 어려웠다. 그러다 보니 합칠 키프레임 데이터를 확인하기 위해 각 클러스터들을 확인하다 보면 어떤 클러스터들끼리 합쳐야 하는지 종종 헷갈리는 경우가 많았다.

(기존 버전에서 클러스터간 데이터 병합 과정 gif 추가)

본 프로젝트에서는 한 화면에서 각 클러스터들을 볼 수 있도록 배치하여 전체 클러스터의 데이터를 한 눈에 확인 가능하도록 UI 를 개선하였다.

(현재 버전 클러스터 편집 화면 추가)

키프레임 편집 기능 또한 단일/부분/전체 선택은 물론 단축키 및 마우스 드래그엔 드랍을 통한 복사/이동 기능 지원 등 기존 프로그램에 비해 사용자 편의성을 대폭 강화하였다.

(현재 버전 키프레임 단일/부분/전체 선택 gif 추가)

(현재 버전 키프레임 단축키 이동 gif 추가)

(현재 버전 키프레임 마우스 드래그엔 드랍 이동 gif 추가)

##### 커맨드 패턴에 기반한 Undo/ Redo 기능 개발

작업자들이 기존 버전을 사용하면서 불편하다고 느꼈던 점 중 하나는 현재 선택한 키프레임 데이터를 실수로 삭제했다던가 혹은 서로 다른 클러스터를 병합 했을 때 이를 복원할 방법이 없었다는 것이였다.

따라서 본 프로젝트에서는 사용자가 현재 수행한 작업에 대하여 이를 되돌릴수 있도록 Undo/ Redo 기능을 개발하였다.

(Redo / Undo 동작 하는 gif 추가)

Undo / Redo 기능 구현하는데는 보통 메멘토 패턴과 커맨드 패턴이 많이 쓰이는데 후자쪽이 자료가 더 많아 기능 개발하는데 있어 보다 수월할 것으로 판단하여 수월할 것으로 보여 커맨드 패턴 기반으로 개발하였다. 또한 Undo / Redo 커맨드를 처리하는 컨트롤러는 어플리케이션 실행중 단 하나의 인스턴스만 존재해야 하는 관계로 싱글턴 패턴을 사용하였다.

(커맨드 매니저 다이어그램 추가)

#####  로고 및 이미지 오버레이 기능 개발

최종 결과 영상에는 영상 하단 중앙에 로고가 삽입 되는데 기존 버전에서 작업하는 경우 세로 직캠 영상을 렌더링 한 후 프리미어 같은 영상 편집툴을 이용하여 로고를 삽입하여 다시 렌더링해야 하는 번거로움이 있었다. 

이번 프로젝트에서는 작업 영상에 삽입한 이미지의 사이즈 및 위치 조절이 가능한  이미지 오버레이 기능을 제공하여 영상 편집툴 사용 없이 바로 결과 영상물을 만들 수 있도록 하였다.

(이미지 오버레이 작업화면 gif 추가)

또한 해당 화면에서 추가한 키프레임들을 기반으로 한 영상 재생 기능도 구현하여 작업한 결과물을 렌더링 전 미리 확인할 수 있는 프리뷰 기능도 기능도 제공하였다.

(이미지 오버레이 재생 화면 gif 추가)

##### 어플리케이션 UI/UX 개선 및 커스텀 UI 컨트롤 개발

어플리케이션 UI/UX 부분 또한 많은 변화가 있었다.

화면 리사이징, 화면 각 메뉴 및 컨트롤 디자인 개선

(이전 버전 영상 로딩한 프로그램 화면 추가)

(현재 버전 영상 로딩한 프로그램 화면 추가)

**인스톨 패키지 개발**

기존 프로그램 배포는 zip으로 압축하여 배포하다보니 프로그램에 대한 신뢰성 및 전문성이 떨어져 보이는 문제가 있었다.

따라서 이러한 부분을 극복하기 위해 인스톨 패키지 검토하였다.

NSIS를 선택한 이유는 여러 프로그램에서 인스톨 패키지로 사용하고 있었고, 무료인데다가 다른 무료 인스톨 패키지 솔루션보다 패키징시 패키지 사이즈가 작아진다는 장점이 있었다. 이를 위해서 NSIS를 사용하였다.

**자동 업데이트 기능 개발**

연구소에서 요청한 기능으로 서버를 이용하여 자동 업데이트 가 되도록 구현하였다. 시나리오는 다음 팟 플레이어의 업데이트 프로세스를 참고하여 개발하였다.

(자동업데이트 되는 gif)

### 어려웠던 점

#### **유니티의 독특한 프레임워크에 대한 익숙하지 않음에 따른 어려움**


### 정리



### 스크린샷

* 프로그램 메인 화면

